<!doctype html>
<html lang="th" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö‡∏£‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•</title>
  <link rel="icon" type="image/png" href="https://img5.pic.in.th/file/secure-sv1/logowatyaischool.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&amp;display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    body {
      box-sizing: border-box;
      font-family: 'Sarabun', sans-serif;
    }
    * {
      font-family: 'Sarabun', sans-serif;
    }
    .gradient-bg {
      background: linear-gradient(135deg, #FFEAD3 0%, #EA7B7B 50%, #D25353 100%);
    }
    .card-shadow {
      box-shadow: 0 10px 40px rgba(158, 59, 59, 0.2);
    }
    .table-header {
      background: linear-gradient(90deg, #D25353, #9E3B3B);
    }
    .score-cell {
      transition: all 0.3s ease;
    }
    .score-cell:hover {
      transform: scale(1.05);
      background: #FFEAD3;
    }
    .medal-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 600;
    }
    .medal-gold {
      background: linear-gradient(135deg, #FFD700, #FFA500);
      color: #8B4513;
    }
    .medal-silver {
      background: linear-gradient(135deg, #E8E8E8, #C0C0C0);
      color: #4A4A4A;
    }
    .medal-bronze {
      background: linear-gradient(135deg, #CD7F32, #B87333);
      color: #FFF;
    }
    .pulse-animation {
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
    .fade-in {
      animation: fadeIn 0.5s ease-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
 </head>
 <body class="h-full">
  <div id="app-container" class="min-h-full gradient-bg p-4 md:p-8 overflow-auto"><!-- Header -->
   <div class="text-center mb-6 fade-in">
    <div class="inline-flex items-center justify-center w-24 h-24 bg-white rounded-full shadow-lg mb-4 p-2"><img src="https://img5.pic.in.th/file/secure-sv1/logowatyaischool.png" alt="‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô" class="w-full h-full object-contain">
    </div>
    <h1 id="main-title" class="text-2xl md:text-3xl font-bold text-white drop-shadow-lg">‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö‡∏£‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•</h1>
    <p class="text-white/80 mt-2 text-sm md:text-base">‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏ó‡∏≤‡∏á‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£ ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î‡πÄ‡∏ó‡∏®‡∏ö‡∏≤‡∏•‡∏ô‡∏Ñ‡∏£‡∏ô‡∏Ñ‡∏£‡∏®‡∏£‡∏µ‡∏ò‡∏£‡∏£‡∏°‡∏£‡∏≤‡∏ä ‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤ 2568</p>
   </div><!-- Search Section -->
   <div class="max-w-2xl mx-auto mb-6 fade-in">
    <div class="bg-white rounded-2xl p-4 md:p-6 card-shadow">
     <div class="flex flex-col md:flex-row gap-3">
      <div class="flex-1 relative">
       <svg class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
       </svg><input type="text" id="search-input" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô" class="w-full pl-12 pr-4 py-3 border-2 border-gray-200 rounded-xl focus:border-[#D25353] focus:outline-none transition-colors text-gray-700">
      </div><button id="search-btn" class="px-6 py-3 bg-gradient-to-r from-[#D25353] to-[#9E3B3B] text-white font-semibold rounded-xl hover:shadow-lg transition-all hover:scale-105 flex items-center justify-center gap-2">
       <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
       </svg> ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ </button> <button id="refresh-btn" class="px-6 py-3 bg-[#FFEAD3] text-[#9E3B3B] font-semibold rounded-xl hover:shadow-lg transition-all hover:scale-105 flex items-center justify-center gap-2">
       <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
       </svg> ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä </button>
     </div>
    </div>
   </div><!-- Results Section -->
   <div id="results-container" class="max-w-5xl mx-auto hidden fade-in"><!-- Student Info Card -->
    <div class="bg-white rounded-2xl p-4 md:p-6 card-shadow mb-6">
     <div class="flex items-center gap-4 mb-4">
      <div class="w-16 h-16 bg-gradient-to-br from-[#EA7B7B] to-[#D25353] rounded-full flex items-center justify-center text-white text-2xl font-bold" id="student-avatar">
       ?
      </div>
      <div class="flex-1">
       <h2 class="text-xl md:text-2xl font-bold text-[#9E3B3B]" id="student-name">-</h2>
       <div class="flex flex-wrap gap-2 mt-2"><span class="px-3 py-1 bg-[#FFEAD3] text-[#9E3B3B] rounded-full text-sm font-medium" id="student-class">‡∏ä‡∏±‡πâ‡∏ô: -</span> <span class="px-3 py-1 bg-[#FFEAD3] text-[#9E3B3B] rounded-full text-sm font-medium" id="student-room">‡∏´‡πâ‡∏≠‡∏á: -</span> <span class="px-3 py-1 bg-[#FFEAD3] text-[#9E3B3B] rounded-full text-sm font-medium" id="student-number">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà: -</span> <span class="px-3 py-1 bg-[#FFEAD3] text-[#9E3B3B] rounded-full text-sm font-medium" id="student-id">‡∏£‡∏´‡∏±‡∏™: -</span>
       </div>
      </div>
     </div>
    </div><!-- Score Table -->
    <div class="bg-white rounded-2xl overflow-hidden card-shadow">
     <div class="table-header text-white p-4">
      <h3 class="text-lg font-bold text-center">üìä ‡∏ú‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏≠‡∏ö‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤</h3>
     </div>
     <div class="overflow-x-auto">
      <table class="w-full">
       <thead>
        <tr class="bg-[#FFEAD3]">
         <th class="px-4 py-3 text-left text-[#9E3B3B] font-semibold">‡∏ß‡∏¥‡∏ä‡∏≤</th>
         <th class="px-4 py-3 text-center text-[#9E3B3B] font-semibold">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏ï‡πá‡∏°</th>
         <th class="px-4 py-3 text-center text-[#9E3B3B] font-semibold">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ</th>
         <th class="px-4 py-3 text-center text-[#9E3B3B] font-semibold">‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞</th>
         <th class="px-4 py-3 text-center text-[#9E3B3B] font-semibold">‡∏£‡∏∞‡∏î‡∏±‡∏ö</th>
        </tr>
       </thead>
       <tbody id="score-table-body"><!-- Scores will be inserted here -->
       </tbody>
       <tfoot>
        <tr class="bg-gradient-to-r from-[#D25353] to-[#9E3B3B] text-white font-bold">
         <td class="px-4 py-4 text-left">‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</td>
         <td class="px-4 py-4 text-center" id="total-full">-</td>
         <td class="px-4 py-4 text-center" id="total-score">-</td>
         <td class="px-4 py-4 text-center" id="total-percent">-</td>
         <td class="px-4 py-4 text-center">-</td>
        </tr>
       </tfoot>
      </table>
     </div><!-- Summary Card -->
     <div class="p-4 md:p-6 bg-[#FFEAD3]/50">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
       <div class="bg-white rounded-xl p-4 text-center card-shadow">
        <div class="text-3xl font-bold text-[#D25353]" id="summary-score">
         -
        </div>
        <div class="text-gray-500 text-sm mt-1">
         ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°
        </div>
       </div>
       <div class="bg-white rounded-xl p-4 text-center card-shadow">
        <div class="text-3xl font-bold text-[#9E3B3B]" id="summary-percent">
         -
        </div>
        <div class="text-gray-500 text-sm mt-1">
         ‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞
        </div>
       </div>
       <div class="bg-white rounded-xl p-4 text-center card-shadow">
        <div class="text-3xl font-bold" id="summary-rank">
         -
        </div>
        <div class="text-gray-500 text-sm mt-1">
         ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡πÉ‡∏ô‡∏ä‡∏±‡πâ‡∏ô
        </div>
       </div>
      </div>
     </div>
    </div>
   </div><!-- Empty State -->
   <div id="empty-state" class="max-w-md mx-auto text-center py-12 fade-in">
    <div class="w-24 h-24 mx-auto bg-white/30 rounded-full flex items-center justify-center mb-4">
     <svg class="w-12 h-12 text-white" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
     </svg>
    </div>
    <h3 class="text-xl font-semibold text-white mb-2">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>
    <p class="text-white/70">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö</p>
   </div><!-- Footer -->
   <div class="text-center mt-8 text-white/80 text-sm">
    <p>¬© 2026 ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏ó‡∏®‡∏ö‡∏≤‡∏•‡∏ß‡∏±‡∏î‡πÉ‡∏´‡∏ç‡πà ‡∏™‡∏á‡∏ß‡∏ô‡∏•‡∏¥‡∏Ç‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</p>
    <p class="mt-1">‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ú‡∏•‡∏™‡∏≠‡∏ö‡∏£‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå | ‡∏û‡∏±‡∏í‡∏ô‡∏≤‡πÇ‡∏î‡∏¢ ‡∏Ñ‡∏£‡∏π‡∏ß‡∏±‡∏ä‡∏£‡∏û‡∏á‡∏®‡πå ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏≠‡∏ö</p>
   </div>
  </div>
  <script>
    const defaultConfig = {
      system_title: '‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö‡∏£‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏• | ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏ó‡∏®‡∏ö‡∏≤‡∏•‡∏ß‡∏±‡∏î‡πÉ‡∏´‡∏ç‡πà',
      search_placeholder: '‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô',
      primary_color: '#D25353',
      secondary_color: '#9E3B3B',
      accent_color: '#FFEAD3',
      background_color: '#EA7B7B',
      text_color: '#FFFFFF'
    };

    let studentsData = [];
    const API_URL = 'https://script.google.com/macros/s/AKfycbyU8xffvXdKk5r-8IP1zcxzlA7bRSjSHKMK1aeMGmPgaxzdssoOoTYFcm_xfph1AW_M/exec';

    // Subject icons
    const subjectIcons = {
      '‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå': 'üî¢',
      '‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå': 'üî¨',
      '‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©': 'üåê',
      '‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢': 'üìö',
      '‡∏™‡∏±‡∏á‡∏Ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤': 'üåç'
    };

    // Get medal badge HTML based on percentage
    function getMedalBadge(percent) {
      const p = parseFloat(percent);
      if (p >= 85) {
        return '<span class="medal-badge medal-gold">ü•á ‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡∏ó‡∏≠‡∏á</span>';
      } else if (p >= 75) {
        return '<span class="medal-badge medal-silver">ü•à ‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡πÄ‡∏á‡∏¥‡∏ô</span>';
      } else if (p >= 65) {
        return '<span class="medal-badge medal-bronze">ü•â ‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡∏ó‡∏≠‡∏á‡πÅ‡∏î‡∏á</span>';
      }
      return '<span class="text-gray-400 text-sm">-</span>';
    }

    // Calculate rank in class based on total score with subject priority tiebreaker
    function calculateRank(currentStudent, allStudents) {
      // ‡∏Å‡∏£‡∏≠‡∏á‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏ô‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô
      const sameClassStudents = allStudents.filter(s => 
        (s.class && currentStudent.class && s.class.toString() === currentStudent.class.toString()) ||
        (s.grade && currentStudent.grade && s.grade.toString() === currentStudent.grade.toString())
      );

      // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°‡πÅ‡∏•‡∏∞‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ñ‡∏ô ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ß‡∏¥‡∏ä‡∏≤
      const studentsWithScores = sameClassStudents.map(s => {
        const subjects = [
          { full: parseFloat(s.math_full) || 0, score: parseFloat(s.math) || 0 },
          { full: parseFloat(s.science_full) || 0, score: parseFloat(s.science) || 0 },
          { full: parseFloat(s.english_full) || 0, score: parseFloat(s.english) || 0 },
          { full: parseFloat(s.thai_full) || 0, score: parseFloat(s.thai) || 0 },
          { full: parseFloat(s.social_full) || 0, score: parseFloat(s.social) || 0 }
        ];

        let totalFull = 0;
        let totalScore = 0;
        subjects.forEach(sub => {
          totalFull += sub.full;
          totalScore += sub.score;
        });

        const percent = totalFull > 0 ? (totalScore / totalFull) * 100 : 0;

        return {
          student_id: s.student_id,
          totalScore: totalScore,
          totalFull: totalFull,
          percent: percent,
          // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ß‡∏¥‡∏ä‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö tiebreaker ‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç
          math: parseFloat(s.math) || 0,
          science: parseFloat(s.science) || 0,
          english: parseFloat(s.english) || 0,
          thai: parseFloat(s.thai) || 0,
          social: parseFloat(s.social) || 0
        };
      });

      // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö 1
      // ‡∏´‡∏≤‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô ‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏Ç‡∏≠‡∏á‡∏ß‡∏¥‡∏ä‡∏≤
      studentsWithScores.sort((a, b) => {
        // ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°‡∏Å‡πà‡∏≠‡∏ô
        if (b.totalScore !== a.totalScore) {
          return b.totalScore - a.totalScore;
        }
        
        // ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏Ç‡∏≠‡∏á‡∏ß‡∏¥‡∏ä‡∏≤
        // 1. ‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå
        if (b.math !== a.math) return b.math - a.math;
        // 2. ‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå
        if (b.science !== a.science) return b.science - a.science;
        // 3. ‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©
        if (b.english !== a.english) return b.english - a.english;
        // 4. ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢
        if (b.thai !== a.thai) return b.thai - a.thai;
        // 5. ‡∏™‡∏±‡∏á‡∏Ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤
        return b.social - a.social;
      });

      // ‡∏´‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ
      const position = studentsWithScores.findIndex(s => 
        s.student_id && currentStudent.student_id && 
        s.student_id.toString() === currentStudent.student_id.toString()
      ) + 1;

      return {
        position: position > 0 ? position : '-',
        total: studentsWithScores.length
      };
    }

    // Load data via JSONP
    function loadData() {
      Swal.fire({
        title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...',
        html: '<div class="pulse-animation">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà</div>',
        allowOutsideClick: false,
        showConfirmButton: false,
        didOpen: () => {
          Swal.showLoading();
        }
      });

      // Remove old callback script if exists
      const oldScript = document.getElementById('jsonp-script');
      if (oldScript) {
        oldScript.remove();
      }

      // Create callback function
      window.handleJSONPResponse = function(data) {
        Swal.close();
        if (data && data.data) {
          studentsData = data.data;
          Swal.fire({
            icon: 'success',
            title: '‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
            text: `‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ${studentsData.length} ‡∏Ñ‡∏ô`,
            confirmButtonColor: '#D25353',
            timer: 2000,
            timerProgressBar: true
          });
        } else {
          Swal.fire({
            icon: 'error',
            title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
            text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ',
            confirmButtonColor: '#D25353'
          });
        }
      };

      // Create JSONP script
      const script = document.createElement('script');
      script.id = 'jsonp-script';
      script.src = `${API_URL}?callback=handleJSONPResponse&_=${Date.now()}`;
      script.onerror = function() {
        Swal.fire({
          icon: 'error',
          title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
          text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ',
          confirmButtonColor: '#D25353'
        });
      };
      document.body.appendChild(script);
    }

    // Search student
    function searchStudent(query) {
      if (!query.trim()) {
        Swal.fire({
          icon: 'warning',
          title: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
          text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô',
          confirmButtonColor: '#D25353'
        });
        return;
      }

      const searchTerm = query.trim().toLowerCase();
      const student = studentsData.find(s => 
        (s.student_id && s.student_id.toString().toLowerCase() === searchTerm)
      );

      if (student) {
        displayStudent(student);
      } else {
        document.getElementById('results-container').classList.add('hidden');
        document.getElementById('empty-state').classList.remove('hidden');
        Swal.fire({
          icon: 'info',
          title: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
          text: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤',
          confirmButtonColor: '#D25353'
        });
      }
    }

    // Display student data
    function displayStudent(student) {
      document.getElementById('results-container').classList.remove('hidden');
      document.getElementById('empty-state').classList.add('hidden');

      // Get name
      const fullName = `${student.firstname || ''} ${student.lastname || ''}`.trim() || student.name || '-';
      const firstChar = (student.firstname || student.name || '?').charAt(0);

      // Update student info
      document.getElementById('student-avatar').textContent = firstChar;
      document.getElementById('student-name').textContent = fullName;
      document.getElementById('student-class').textContent = `‡∏ä‡∏±‡πâ‡∏ô‡∏õ‡∏£‡∏∞‡∏ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà: ${student.class || student.grade || '-'}`;
      document.getElementById('student-room').textContent = `‡∏´‡πâ‡∏≠‡∏á: ${student.room || '-'}`;
      document.getElementById('student-number').textContent = `‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà: ${student.number || student.no || '-'}`;
      document.getElementById('student-id').textContent = `‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô: ${student.student_id || '-'}`;

      // Subjects
      const subjects = [
        { name: '‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå', full: student.math_full || 100, score: student.math || 0 },
        { name: '‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå', full: student.science_full || 100, score: student.science || 0 },
        { name: '‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©', full: student.english_full || 100, score: student.english || 0 },
        { name: '‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢', full: student.thai_full || 100, score: student.thai || 0 },
        { name: '‡∏™‡∏±‡∏á‡∏Ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤', full: student.social_full || 100, score: student.social || 0 }
      ];

      // Build table
      const tbody = document.getElementById('score-table-body');
      tbody.innerHTML = '';

      let totalFull = 0;
      let totalScore = 0;

      subjects.forEach((subject, index) => {
        const full = parseFloat(subject.full) || 0;
        const score = parseFloat(subject.score) || 0;
        const percent = full > 0 ? ((score / full) * 100).toFixed(2) : 0;
        
        totalFull += full;
        totalScore += score;

        const row = document.createElement('tr');
        row.className = index % 2 === 0 ? 'bg-white' : 'bg-gray-50';
        row.innerHTML = `
          <td class="px-4 py-3 text-left score-cell">
            <span class="mr-2">${subjectIcons[subject.name] || 'üìñ'}</span>
            ${subject.name}
          </td>
          <td class="px-4 py-3 text-center score-cell font-medium">${full}</td>
          <td class="px-4 py-3 text-center score-cell font-bold text-[#D25353]">${score}</td>
          <td class="px-4 py-3 text-center score-cell">
            <span class="px-2 py-1 rounded-full text-sm font-medium ${getPercentColor(percent)}">
              ${percent}%
            </span>
          </td>
          <td class="px-4 py-3 text-center score-cell">
            ${getMedalBadge(percent)}
          </td>
        `;
        tbody.appendChild(row);
      });

      // Update totals
      const totalPercent = totalFull > 0 ? ((totalScore / totalFull) * 100).toFixed(2) : 0;
      document.getElementById('total-full').textContent = totalFull;
      document.getElementById('total-score').textContent = totalScore;
      document.getElementById('total-percent').textContent = `${totalPercent}%`;

      // Update summary
      document.getElementById('summary-score').textContent = `${totalScore}/${totalFull}`;
      document.getElementById('summary-percent').textContent = `${totalPercent}%`;
      
      // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö
      const rank = calculateRank(student, studentsData);
      const rankElement = document.getElementById('summary-rank');
      rankElement.textContent = `${rank.position}/${rank.total}`;
      
      // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ‡∏ï‡∏≤‡∏°‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö
      if (rank.position === 1) {
        rankElement.className = 'text-3xl font-bold text-yellow-500'; // ‡∏ó‡∏≠‡∏á
      } else if (rank.position === 2) {
        rankElement.className = 'text-3xl font-bold text-gray-400'; // ‡πÄ‡∏á‡∏¥‡∏ô
      } else if (rank.position === 3) {
        rankElement.className = 'text-3xl font-bold text-orange-600'; // ‡∏ó‡∏≠‡∏á‡πÅ‡∏î‡∏á
      } else if (rank.position <= 10) {
        rankElement.className = 'text-3xl font-bold text-[#D25353]'; // ‡∏™‡∏µ‡πÅ‡∏î‡∏á ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö 4-10
      } else {
        rankElement.className = 'text-3xl font-bold text-gray-600'; // ‡∏™‡∏µ‡πÄ‡∏ó‡∏≤ ‡∏ô‡∏≠‡∏Å‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö 10
      }

      // Scroll to results
      document.getElementById('results-container').scrollIntoView({ behavior: 'smooth' });
    }

    // Get color based on percentage
    function getPercentColor(percent) {
      const p = parseFloat(percent);
      if (p >= 80) return 'bg-green-100 text-green-700';
      if (p >= 70) return 'bg-blue-100 text-blue-700';
      if (p >= 60) return 'bg-yellow-100 text-yellow-700';
      if (p >= 50) return 'bg-orange-100 text-orange-700';
      return 'bg-red-100 text-red-700';
    }

    // Config change handler
    async function onConfigChange(config) {
      document.getElementById('main-title').textContent = config.system_title || defaultConfig.system_title;
      document.getElementById('search-input').placeholder = config.search_placeholder || defaultConfig.search_placeholder;
    }

    // Initialize Element SDK
    if (window.elementSdk) {
      window.elementSdk.init({
        defaultConfig,
        onConfigChange,
        mapToCapabilities: (config) => ({
          recolorables: [
            {
              get: () => config.primary_color || defaultConfig.primary_color,
              set: (value) => {
                config.primary_color = value;
                window.elementSdk.setConfig({ primary_color: value });
              }
            },
            {
              get: () => config.secondary_color || defaultConfig.secondary_color,
              set: (value) => {
                config.secondary_color = value;
                window.elementSdk.setConfig({ secondary_color: value });
              }
            },
            {
              get: () => config.accent_color || defaultConfig.accent_color,
              set: (value) => {
                config.accent_color = value;
                window.elementSdk.setConfig({ accent_color: value });
              }
            },
            {
              get: () => config.background_color || defaultConfig.background_color,
              set: (value) => {
                config.background_color = value;
                window.elementSdk.setConfig({ background_color: value });
              }
            },
            {
              get: () => config.text_color || defaultConfig.text_color,
              set: (value) => {
                config.text_color = value;
                window.elementSdk.setConfig({ text_color: value });
              }
            }
          ],
          borderables: [],
          fontEditable: undefined,
          fontSizeable: undefined
        }),
        mapToEditPanelValues: (config) => new Map([
          ['system_title', config.system_title || defaultConfig.system_title],
          ['search_placeholder', config.search_placeholder || defaultConfig.search_placeholder]
        ])
      });
    }

    // Event listeners
    document.getElementById('search-btn').addEventListener('click', () => {
      const query = document.getElementById('search-input').value;
      searchStudent(query);
    });

    document.getElementById('search-input').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        const query = document.getElementById('search-input').value;
        searchStudent(query);
      }
    });

    document.getElementById('refresh-btn').addEventListener('click', () => {
      loadData();
    });

    // Initial load
    loadData();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9bd514f833417336',t:'MTc2ODMwOTI4My4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>