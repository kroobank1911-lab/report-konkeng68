<!doctype html>
<html lang="th" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö‡∏£‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•</title>
  <link rel="icon" type="image/png" href="https://img5.pic.in.th/file/secure-sv1/80102321_0_20180120-205159-removebg-preview.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&amp;display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    body {
      box-sizing: border-box;
      font-family: 'Sarabun', sans-serif;
    }
    * {
      font-family: 'Sarabun', sans-serif;
    }
    /* ‡∏õ‡∏£‡∏±‡∏ö‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÉ‡∏´‡πâ‡∏î‡∏π‡∏´‡∏£‡∏π‡∏´‡∏£‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏™‡∏µ Blue -> Mauve */
    .gradient-bg {
      background: linear-gradient(135deg, #667BC6 0%, #DA7297 100%);
      background-attachment: fixed;
    }
    /* ‡πÄ‡∏á‡∏≤‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡πÇ‡∏ó‡∏ô‡πÄ‡∏¢‡πá‡∏ô */
    .card-shadow {
      box-shadow: 0 15px 35px rgba(102, 123, 198, 0.15);
      border: 1px solid rgba(255, 255, 255, 0.6);
    }
    /* ‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÑ‡∏•‡πà‡πÄ‡∏â‡∏î‡∏™‡∏µ */
    .table-header {
      background: linear-gradient(90deg, #667BC6, #DA7297);
    }
    .score-cell {
      transition: all 0.3s ease;
    }
    .score-cell:hover {
      transform: scale(1.02);
      background: #FDFFD2; /* Hover ‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡∏Ñ‡∏£‡∏µ‡∏° */
    }
    .medal-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 600;
    }
    .medal-gold {
      background: linear-gradient(135deg, #FFD700, #FDB931);
      color: #8B4513;
      box-shadow: 0 2px 5px rgba(255, 215, 0, 0.3);
    }
    .medal-silver {
      background: linear-gradient(135deg, #E0E0E0, #BDBDBD);
      color: #424242;
      box-shadow: 0 2px 5px rgba(192, 192, 192, 0.3);
    }
    .medal-bronze {
      background: linear-gradient(135deg, #E6A57E, #CD7F32);
      color: #FFFFFF;
      box-shadow: 0 2px 5px rgba(205, 127, 50, 0.3);
    }
    .pulse-animation {
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
    .fade-in {
      animation: fadeIn 0.6s cubic-bezier(0.22, 1, 0.36, 1);
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    /* Custom Scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
    }
    ::-webkit-scrollbar-track {
      background: rgba(253, 255, 210, 0.3);
    }
    ::-webkit-scrollbar-thumb {
      background: #FFB4C2;
      border-radius: 4px;
    }
    ::-webkit-scrollbar-thumb:hover {
      background: #DA7297;
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
 </head>
 <body class="h-full">
  <div id="app-container" class="min-h-full gradient-bg p-4 md:p-8 overflow-auto"><div class="text-center mb-8 fade-in">
    <div class="inline-flex items-center justify-center w-24 h-24 bg-white/90 backdrop-blur-sm rounded-full shadow-xl mb-4 p-2 ring-4 ring-[#FFB4C2]/30"><img src="https://img5.pic.in.th/file/secure-sv1/80102321_0_20180120-205159-removebg-preview.png" alt="‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô" class="w-full h-full object-contain">
    </div>
    <h1 id="main-title" class="text-2xl md:text-3xl font-bold text-white drop-shadow-md tracking-wide">‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö‡∏£‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•</h1>
    <p class="text-[#FDFFD2] mt-2 text-sm md:text-base font-light tracking-wider">‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏ó‡∏≤‡∏á‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£ ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î‡πÄ‡∏ó‡∏®‡∏ö‡∏≤‡∏•‡∏ô‡∏Ñ‡∏£‡∏ô‡∏Ñ‡∏£‡∏®‡∏£‡∏µ‡∏ò‡∏£‡∏£‡∏°‡∏£‡∏≤‡∏ä</p>
   <p class="text-[#FDFFD2] mt-2 text-sm md:text-base font-light tracking-wider">(‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£)</p>
   </div><div class="max-w-2xl mx-auto mb-8 fade-in">
    <div class="bg-white/95 backdrop-blur-md rounded-2xl p-6 card-shadow border border-white">
     <div class="flex flex-col md:flex-row gap-3">
      <div class="flex-1 relative">
       <svg class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-[#667BC6]" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
       </svg><input type="text" id="search-input" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô" class="w-full pl-12 pr-4 py-3.5 border border-[#FFB4C2] rounded-xl focus:border-[#DA7297] focus:ring-2 focus:ring-[#FFB4C2]/50 focus:outline-none transition-all text-gray-700 bg-[#FDFFD2]/20">
      </div>
      <button id="search-btn" class="px-8 py-3.5 bg-gradient-to-r from-[#667BC6] to-[#DA7297] text-white font-semibold rounded-xl shadow-lg shadow-[#667BC6]/30 hover:shadow-xl hover:scale-105 transition-all flex items-center justify-center gap-2">
       <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
       </svg> ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ </button> 
      <button id="refresh-btn" class="px-6 py-3.5 bg-[#FDFFD2] text-[#667BC6] font-semibold rounded-xl border border-[#FFB4C2] hover:bg-white hover:shadow-lg transition-all flex items-center justify-center gap-2">
       <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
       </svg> ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä </button>
     </div>
    </div>
   </div><div id="results-container" class="max-w-5xl mx-auto hidden fade-in"><div class="bg-white/95 backdrop-blur-md rounded-2xl p-6 card-shadow mb-6 border border-white">
     <div class="flex items-center gap-5 mb-2">
      <div class="w-20 h-20 bg-gradient-to-br from-[#FFB4C2] to-[#DA7297] rounded-full flex items-center justify-center text-white text-3xl font-bold shadow-md" id="student-avatar">
       ?
      </div>
      <div class="flex-1">
       <h2 class="text-2xl md:text-3xl font-bold text-[#667BC6]" id="student-name">-</h2>
       <div class="flex flex-wrap gap-2 mt-3">
        <span class="px-4 py-1.5 bg-[#FDFFD2] text-[#667BC6] rounded-full text-sm font-semibold border border-[#FFB4C2]/50" id="student-class">‡∏ä‡∏±‡πâ‡∏ô: -</span> 
        <span class="px-4 py-1.5 bg-[#FDFFD2] text-[#667BC6] rounded-full text-sm font-semibold border border-[#FFB4C2]/50" id="student-room">‡∏´‡πâ‡∏≠‡∏á: -</span> 
        <span class="px-4 py-1.5 bg-[#FDFFD2] text-[#667BC6] rounded-full text-sm font-semibold border border-[#FFB4C2]/50" id="student-number">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà: -</span> 
        <span class="px-4 py-1.5 bg-[#F3F4F6] text-gray-600 rounded-full text-sm font-medium border border-gray-200" id="student-id">‡∏£‡∏´‡∏±‡∏™: -</span>
       </div>
      </div>
     </div>
    </div><div class="bg-white rounded-2xl overflow-hidden card-shadow border border-white">
     <div class="table-header text-white p-5">
      <h3 class="text-xl font-bold text-center tracking-wide flex items-center justify-center gap-2">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
        ‡∏ú‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏≠‡∏ö‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤
      </h3>
     </div>
     <div class="overflow-x-auto">
      <table class="w-full">
       <thead>
        <tr class="bg-[#FDFFD2]">
         <th class="px-5 py-4 text-left text-[#667BC6] font-bold">‡∏ß‡∏¥‡∏ä‡∏≤</th>
         <th class="px-5 py-4 text-center text-[#667BC6] font-bold">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏ï‡πá‡∏°</th>
         <th class="px-5 py-4 text-center text-[#667BC6] font-bold">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ</th>
         <th class="px-5 py-4 text-center text-[#667BC6] font-bold">‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞</th>
         <th class="px-5 py-4 text-center text-[#667BC6] font-bold">‡∏£‡∏∞‡∏î‡∏±‡∏ö</th>
        </tr>
       </thead>
       <tbody id="score-table-body" class="divide-y divide-[#FFB4C2]/30"></tbody>
       <tfoot>
        <tr class="bg-gradient-to-r from-[#667BC6] to-[#DA7297] text-white font-bold">
         <td class="px-5 py-5 text-left text-lg">‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</td>
         <td class="px-5 py-5 text-center text-lg" id="total-full">-</td>
         <td class="px-5 py-5 text-center text-lg" id="total-score">-</td>
         <td class="px-5 py-5 text-center text-lg" id="total-percent">-</td>
         <td class="px-5 py-5 text-center">-</td>
        </tr>
       </tfoot>
      </table>
     </div><div class="p-6 bg-[#FDFFD2]/30">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-5">
       <div class="bg-white rounded-xl p-5 text-center card-shadow border border-[#FFB4C2]/20">
        <div class="text-4xl font-bold text-[#DA7297]" id="summary-score">
         -
        </div>
        <div class="text-[#667BC6] font-medium text-sm mt-2 uppercase tracking-wide">
         ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°
        </div>
       </div>
       <div class="bg-white rounded-xl p-5 text-center card-shadow border border-[#FFB4C2]/20">
        <div class="text-4xl font-bold text-[#667BC6]" id="summary-percent">
         -
        </div>
        <div class="text-[#DA7297] font-medium text-sm mt-2 uppercase tracking-wide">
         ‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞
        </div>
       </div>
       <div class="bg-white rounded-xl p-5 text-center card-shadow border border-[#FFB4C2]/20">
        <div class="text-4xl font-bold" id="summary-rank">
         -
        </div>
        <div class="text-gray-500 font-medium text-sm mt-2 uppercase tracking-wide">
         ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡πÉ‡∏ô‡∏ä‡∏±‡πâ‡∏ô
        </div>
       </div>
      </div>
     </div>
    </div>
   </div><div id="empty-state" class="max-w-md mx-auto text-center py-16 fade-in">
    <div class="w-24 h-24 mx-auto bg-white/20 backdrop-blur-sm rounded-full flex items-center justify-center mb-6 ring-4 ring-[#FDFFD2]/30">
     <svg class="w-12 h-12 text-white" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
     </svg>
    </div>
    <h3 class="text-2xl font-semibold text-white mb-2 drop-shadow-md">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>
    <p class="text-[#FDFFD2] text-lg">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö</p>
   </div><div class="text-center mt-12 text-white/90 text-sm">
    <p class="font-medium">¬© 2026 ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏ó‡∏®‡∏ö‡∏≤‡∏•‡∏ß‡∏±‡∏î‡∏®‡∏≤‡∏•‡∏≤‡∏°‡∏µ‡∏ä‡∏±‡∏¢ ‡∏™‡∏á‡∏ß‡∏ô‡∏•‡∏¥‡∏Ç‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</p>
    <p class="mt-1 opacity-70">‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ú‡∏•‡∏™‡∏≠‡∏ö‡∏£‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå | ‡∏û‡∏±‡∏í‡∏ô‡∏≤‡πÇ‡∏î‡∏¢ ‡∏Ñ‡∏£‡∏π‡∏ß‡∏£‡∏û‡∏• ‡∏Ñ‡∏£‡∏∏‡∏ë‡∏ß‡∏¥‡∏™‡∏±‡∏¢</p>
   </div>
  </div>
  <script>
    const defaultConfig = {
      system_title: '‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö‡∏£‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏• | ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏ó‡∏®‡∏ö‡∏≤‡∏•‡∏ß‡∏±‡∏î‡∏®‡∏≤‡∏•‡∏≤‡∏°‡∏µ‡∏ä‡∏±‡∏¢',
      search_placeholder: '‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô',
      primary_color: '#667BC6',
      secondary_color: '#DA7297',
      accent_color: '#FDFFD2',
      background_color: '#FFB4C2',
      text_color: '#FFFFFF'
    };

    let studentsData = [];
    const API_URL = 'https://script.google.com/macros/s/AKfycbwkcr47YBLPtipoAT2J2nX1uC9dNtlMGlpt6CVLuy-D2uMe3Lf1QJ5rqOmzIs3c4wt_vg/exec';

    // Subject icons
    const subjectIcons = {
      '‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå': 'üî¢',
      '‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå': 'üî¨',
      '‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©': 'üåê',
      '‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢': 'üìö',
      '‡∏™‡∏±‡∏á‡∏Ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤': 'üåç'
    };

    // Get medal badge HTML based on percentage
    function getMedalBadge(percent) {
      const p = parseFloat(percent);
      if (p >= 85) {
        return '<span class="medal-badge medal-gold">ü•á ‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡∏ó‡∏≠‡∏á</span>';
      } else if (p >= 75) {
        return '<span class="medal-badge medal-silver">ü•à ‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡πÄ‡∏á‡∏¥‡∏ô</span>';
      } else if (p >= 65) {
        return '<span class="medal-badge medal-bronze">ü•â ‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡∏ó‡∏≠‡∏á‡πÅ‡∏î‡∏á</span>';
      }
      return '<span class="text-gray-400 text-sm">-</span>';
    }

    // Calculate rank in class based on total score with subject priority tiebreaker
    function calculateRank(currentStudent, allStudents) {
      // ‡∏Å‡∏£‡∏≠‡∏á‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏ô‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô
      const sameClassStudents = allStudents.filter(s => 
        (s.class && currentStudent.class && s.class.toString() === currentStudent.class.toString()) ||
        (s.grade && currentStudent.grade && s.grade.toString() === currentStudent.grade.toString())
      );

      // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°‡πÅ‡∏•‡∏∞‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ñ‡∏ô ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ß‡∏¥‡∏ä‡∏≤
      const studentsWithScores = sameClassStudents.map(s => {
        const subjects = [
          { full: parseFloat(s.math_full) || 0, score: parseFloat(s.math) || 0 },
          { full: parseFloat(s.science_full) || 0, score: parseFloat(s.science) || 0 },
          { full: parseFloat(s.english_full) || 0, score: parseFloat(s.english) || 0 },
          { full: parseFloat(s.thai_full) || 0, score: parseFloat(s.thai) || 0 },
          { full: parseFloat(s.social_full) || 0, score: parseFloat(s.social) || 0 }
        ];

        let totalFull = 0;
        let totalScore = 0;
        subjects.forEach(sub => {
          totalFull += sub.full;
          totalScore += sub.score;
        });

        const percent = totalFull > 0 ? (totalScore / totalFull) * 100 : 0;

        return {
          student_id: s.student_id,
          totalScore: totalScore,
          totalFull: totalFull,
          percent: percent,
          // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ß‡∏¥‡∏ä‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö tiebreaker ‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç
          math: parseFloat(s.math) || 0,
          science: parseFloat(s.science) || 0,
          english: parseFloat(s.english) || 0,
          thai: parseFloat(s.thai) || 0,
          social: parseFloat(s.social) || 0
        };
      });

      // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö 1
      // ‡∏´‡∏≤‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô ‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏Ç‡∏≠‡∏á‡∏ß‡∏¥‡∏ä‡∏≤
      studentsWithScores.sort((a, b) => {
        // ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°‡∏Å‡πà‡∏≠‡∏ô
        if (b.totalScore !== a.totalScore) {
          return b.totalScore - a.totalScore;
        }
        
        // ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏Ç‡∏≠‡∏á‡∏ß‡∏¥‡∏ä‡∏≤
        // 1. ‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå
        if (b.math !== a.math) return b.math - a.math;
        // 2. ‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå
        if (b.science !== a.science) return b.science - a.science;
        // 3. ‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©
        if (b.english !== a.english) return b.english - a.english;
        // 4. ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢
        if (b.thai !== a.thai) return b.thai - a.thai;
        // 5. ‡∏™‡∏±‡∏á‡∏Ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤
        return b.social - a.social;
      });

      // ‡∏´‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ
      const position = studentsWithScores.findIndex(s => 
        s.student_id && currentStudent.student_id && 
        s.student_id.toString() === currentStudent.student_id.toString()
      ) + 1;

      return {
        position: position > 0 ? position : '-',
        total: studentsWithScores.length
      };
    }

    // Load data via JSONP
    function loadData() {
      Swal.fire({
        title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...',
        html: '<div class="pulse-animation" style="color:#667BC6">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà</div>',
        allowOutsideClick: false,
        showConfirmButton: false,
        didOpen: () => {
          Swal.showLoading();
        }
      });

      // Remove old callback script if exists
      const oldScript = document.getElementById('jsonp-script');
      if (oldScript) {
        oldScript.remove();
      }

      // Create callback function
      window.handleJSONPResponse = function(data) {
        Swal.close();
        if (data && data.data) {
          studentsData = data.data;
          Swal.fire({
            icon: 'success',
            title: '‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
            text: `‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ${studentsData.length} ‡∏Ñ‡∏ô`,
            confirmButtonColor: '#667BC6',
            timer: 2000,
            timerProgressBar: true
          });
        } else {
          Swal.fire({
            icon: 'error',
            title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
            text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ',
            confirmButtonColor: '#DA7297'
          });
        }
      };

      // Create JSONP script
      const script = document.createElement('script');
      script.id = 'jsonp-script';
      script.src = `${API_URL}?callback=handleJSONPResponse&_=${Date.now()}`;
      script.onerror = function() {
        Swal.fire({
          icon: 'error',
          title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
          text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ',
          confirmButtonColor: '#DA7297'
        });
      };
      document.body.appendChild(script);
    }

    // Search student
    function searchStudent(query) {
      if (!query.trim()) {
        Swal.fire({
          icon: 'warning',
          title: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
          text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô',
          confirmButtonColor: '#DA7297'
        });
        return;
      }

      const searchTerm = query.trim().toLowerCase();
      const student = studentsData.find(s => 
        (s.student_id && s.student_id.toString().toLowerCase() === searchTerm)
      );

      if (student) {
        displayStudent(student);
      } else {
        document.getElementById('results-container').classList.add('hidden');
        document.getElementById('empty-state').classList.remove('hidden');
        Swal.fire({
          icon: 'info',
          title: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
          text: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤',
          confirmButtonColor: '#667BC6'
        });
      }
    }

    // Display student data
    function displayStudent(student) {
      document.getElementById('results-container').classList.remove('hidden');
      document.getElementById('empty-state').classList.add('hidden');

      // Get name
      const fullName = `${student.firstname || ''} ${student.lastname || ''}`.trim() || student.name || '-';
      const firstChar = (student.firstname || student.name || '?').charAt(0);

      // Update student info
      document.getElementById('student-avatar').textContent = firstChar;
      document.getElementById('student-name').textContent = fullName;
      document.getElementById('student-class').textContent = `‡∏ä‡∏±‡πâ‡∏ô‡∏õ‡∏£‡∏∞‡∏ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà: ${student.class || student.grade || '-'}`;
      document.getElementById('student-room').textContent = `‡∏´‡πâ‡∏≠‡∏á: ${student.room || '-'}`;
      document.getElementById('student-number').textContent = `‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà: ${student.number || student.no || '-'}`;
      document.getElementById('student-id').textContent = `‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô: ${student.student_id || '-'}`;

      // Subjects
      const subjects = [
        { name: '‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå', full: student.math_full || 100, score: student.math || 0 },
        { name: '‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå', full: student.science_full || 100, score: student.science || 0 },
        { name: '‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©', full: student.english_full || 100, score: student.english || 0 },
        { name: '‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢', full: student.thai_full || 100, score: student.thai || 0 },
        { name: '‡∏™‡∏±‡∏á‡∏Ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤', full: student.social_full || 100, score: student.social || 0 }
      ];

      // Build table
      const tbody = document.getElementById('score-table-body');
      tbody.innerHTML = '';

      let totalFull = 0;
      let totalScore = 0;

      subjects.forEach((subject, index) => {
        const full = parseFloat(subject.full) || 0;
        const score = parseFloat(subject.score) || 0;
        const percent = full > 0 ? ((score / full) * 100).toFixed(2) : 0;
        
        totalFull += full;
        totalScore += score;

        const row = document.createElement('tr');
        row.className = index % 2 === 0 ? 'bg-white' : 'bg-[#FDFFD2]/30'; // ‡∏™‡∏•‡∏±‡∏ö‡∏™‡∏µ‡∏Ç‡∏≤‡∏ß‡∏Å‡∏±‡∏ö‡∏™‡∏µ‡∏Ñ‡∏£‡∏µ‡∏°‡∏à‡∏≤‡∏á‡πÜ
        row.innerHTML = `
          <td class="px-5 py-4 text-left score-cell text-gray-700">
            <span class="mr-2 text-xl">${subjectIcons[subject.name] || 'üìñ'}</span>
            <span class="font-medium">${subject.name}</span>
          </td>
          <td class="px-5 py-4 text-center score-cell font-medium text-gray-500">${full}</td>
          <td class="px-5 py-4 text-center score-cell font-bold text-[#DA7297] text-lg">${score}</td>
          <td class="px-5 py-4 text-center score-cell">
            <span class="px-3 py-1 rounded-full text-sm font-bold ${getPercentColor(percent)}">
              ${percent}%
            </span>
          </td>
          <td class="px-5 py-4 text-center score-cell">
            ${getMedalBadge(percent)}
          </td>
        `;
        tbody.appendChild(row);
      });

      // Update totals
      const totalPercent = totalFull > 0 ? ((totalScore / totalFull) * 100).toFixed(2) : 0;
      document.getElementById('total-full').textContent = totalFull;
      document.getElementById('total-score').textContent = totalScore;
      document.getElementById('total-percent').textContent = `${totalPercent}%`;

      // Update summary
      document.getElementById('summary-score').textContent = `${totalScore}/${totalFull}`;
      document.getElementById('summary-percent').textContent = `${totalPercent}%`;
      
      // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö
      const rank = calculateRank(student, studentsData);
      const rankElement = document.getElementById('summary-rank');
      rankElement.textContent = `${rank.position}/${rank.total}`;
      
      // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ‡∏ï‡∏≤‡∏°‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö
      if (rank.position === 1) {
        rankElement.className = 'text-4xl font-bold text-[#FDB931] drop-shadow-sm'; // ‡∏ó‡∏≠‡∏á
      } else if (rank.position === 2) {
        rankElement.className = 'text-4xl font-bold text-gray-400 drop-shadow-sm'; // ‡πÄ‡∏á‡∏¥‡∏ô
      } else if (rank.position === 3) {
        rankElement.className = 'text-4xl font-bold text-[#CD7F32] drop-shadow-sm'; // ‡∏ó‡∏≠‡∏á‡πÅ‡∏î‡∏á
      } else if (rank.position <= 10) {
        rankElement.className = 'text-4xl font-bold text-[#DA7297]'; // ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö 4-10
      } else {
        rankElement.className = 'text-4xl font-bold text-[#667BC6]'; // ‡∏ô‡∏≠‡∏Å‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö 10
      }

      // Scroll to results
      document.getElementById('results-container').scrollIntoView({ behavior: 'smooth' });
    }

    // Get color based on percentage
    function getPercentColor(percent) {
      const p = parseFloat(percent);
      // ‡πÉ‡∏ä‡πâ‡∏™‡∏µ‡πÄ‡∏î‡∏¥‡∏°‡πÅ‡∏ï‡πà‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏°‡πÉ‡∏´‡πâ‡∏≠‡πà‡∏≠‡∏ô‡∏•‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏±‡∏ö‡∏ò‡∏µ‡∏°
      if (p >= 80) return 'bg-green-100 text-green-700 ring-1 ring-green-200';
      if (p >= 70) return 'bg-blue-100 text-blue-700 ring-1 ring-blue-200';
      if (p >= 60) return 'bg-yellow-100 text-yellow-700 ring-1 ring-yellow-200';
      if (p >= 50) return 'bg-orange-100 text-orange-700 ring-1 ring-orange-200';
      return 'bg-red-100 text-red-700 ring-1 ring-red-200';
    }

    // Config change handler
    async function onConfigChange(config) {
      document.getElementById('main-title').textContent = config.system_title || defaultConfig.system_title;
      document.getElementById('search-input').placeholder = config.search_placeholder || defaultConfig.search_placeholder;
    }

    // Initialize Element SDK
    if (window.elementSdk) {
      window.elementSdk.init({
        defaultConfig,
        onConfigChange,
        mapToCapabilities: (config) => ({
          recolorables: [
            {
              get: () => config.primary_color || defaultConfig.primary_color,
              set: (value) => {
                config.primary_color = value;
                window.elementSdk.setConfig({ primary_color: value });
              }
            },
            {
              get: () => config.secondary_color || defaultConfig.secondary_color,
              set: (value) => {
                config.secondary_color = value;
                window.elementSdk.setConfig({ secondary_color: value });
              }
            },
            {
              get: () => config.accent_color || defaultConfig.accent_color,
              set: (value) => {
                config.accent_color = value;
                window.elementSdk.setConfig({ accent_color: value });
              }
            },
            {
              get: () => config.background_color || defaultConfig.background_color,
              set: (value) => {
                config.background_color = value;
                window.elementSdk.setConfig({ background_color: value });
              }
            },
            {
              get: () => config.text_color || defaultConfig.text_color,
              set: (value) => {
                config.text_color = value;
                window.elementSdk.setConfig({ text_color: value });
              }
            }
          ],
          borderables: [],
          fontEditable: undefined,
          fontSizeable: undefined
        }),
        mapToEditPanelValues: (config) => new Map([
          ['system_title', config.system_title || defaultConfig.system_title],
          ['search_placeholder', config.search_placeholder || defaultConfig.search_placeholder]
        ])
      });
    }

    // Event listeners
    document.getElementById('search-btn').addEventListener('click', () => {
      const query = document.getElementById('search-input').value;
      searchStudent(query);
    });

    document.getElementById('search-input').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        const query = document.getElementById('search-input').value;
        searchStudent(query);
      }
    });

    document.getElementById('refresh-btn').addEventListener('click', () => {
      loadData();
    });

    // Initial load
    loadData();
  </script>
 </body>
</html>




